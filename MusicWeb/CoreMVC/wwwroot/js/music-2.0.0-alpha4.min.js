'use strict';
$(function () {
    function a(p) {
        var r = null
            , s = [];
        return location.search.substr(1).split('&').forEach(function (u) {
            s = u.split('='),
                s[0] === p && (r = decodeURIComponent(s[1]))
        }),
            r
    }
    function b(p, r) {
        window.history && window.history.pushState && window.history.pushState(null, p, r)
    }
    function c(p) {
        var r = location.href.split('?')[0];
        return p ? r + p : r
    }
    function d(p) {
        try {
            return JSON.stringify(p)
        } catch (r) { }
    }
    var f = !1
        , g = null
        , h = []
        , i = '//od9jg7suh.qnssl.com/2333/img/nopic.jpg'
        , j = document.title
        , k = a('name')
        , l = a('id')
        , m = a('url')
        , n = a('type')
        , o = function (p) {
            window._czc && (!f && (window._czc.push(['_setAccount', '1255392159']),
                f = !0),
                window._czc.push(p))
        };
    (k || l) && n && setTimeout(function () {
        $('#j-input').val(k || l),
            $('#j-type input[value="' + n + '"]').prop('checked', !0),
            k && ($('#j-nav [data-filter="name"]').trigger('click'),
                o(['_trackEvent', 'AutoSend', 'name', k + ',' + n])),
            l && ($('#j-nav [data-filter="id"]').trigger('click'),
                o(['_trackEvent', 'AutoSend', 'id', l + ',' + n])),
            $('#j-validator').trigger('submit')
    }, 0),
        m && setTimeout(function () {
            $('#j-type').hide(),
                $('#j-input').val(m),
                $('#j-nav [data-filter="url"]').trigger('click'),
                $('#j-validator').trigger('submit'),
                o(['_trackEvent', 'AutoSend', 'url', m])
        }, 0),
        $('#j-nav').on('click', 'li', function () {
            var p = {
                name: '\u4F8B\u5982: \u4E0D\u8981\u8BF4\u8BDD \u9648\u5955\u8FC5',
                id: '\u4F8B\u5982: 25906124',
                url: '\u4F8B\u5982: http://music.163.com/#/song?id=25906124',
                pattern_name: '^.+$',
                pattern_id: '^[\\w\\/\\|]+$',
                pattern_url: '^https?:\\/\\/\\S+$'
            }
                , r = $(this).data('filter');
            $(this).addClass('am-active').siblings('li').removeClass('am-active'),
                $('#j-input').data('filter', r).attr({
                    placeholder: p[r],
                    pattern: p['pattern_' + r]
                }).removeClass('am-field-valid am-field-error am-active').closest('.am-form-group').removeClass('am-form-success am-form-error').find('.am-alert').hide(),
                'url' === r ? $('#j-type').hide() : $('#j-type').show()
        }),
        $('#j-validator').validator({
            onValid: function onValid(p) {
                $(p.field).closest('.am-form-group').find('.am-alert').hide()
            },
            onInValid: function onInValid(p) {
                var r = $(p.field)
                    , s = r.closest('.am-form-group')
                    , w = s.find('.am-alert')
                    , x = {
                        name: '\u5C06 \u540D\u79F0 \u548C \u4F5C\u8005 \u4E00\u8D77\u8F93\u5165\u53EF\u63D0\u9AD8\u5339\u914D\u5EA6',
                        id: '\u8F93\u5165\u9519\u8BEF\uFF0C\u8BF7\u67E5\u770B\u4E0B\u9762\u7684\u5E2E\u52A9',
                        url: '\u8F93\u5165\u9519\u8BEF\uFF0C\u8BF7\u67E5\u770B\u4E0B\u9762\u7684\u5E2E\u52A9'
                    }[r.data('filter')] || this.getValidationMessage(p);
                w.length || (w = $('<div class="am-alert am-alert-danger am-animation-shake"></div>').hide().appendTo(s)),
                    w.html(x).show(),
                    o(['_trackEvent', 'inValid', r.data('filter') + $('input[name="music_type"]:checked').val() + $.trim($('#j-input').val()), x])
            },
            submit: function submit(p) {
                if (p.preventDefault(),
                    this.isFormValid()) {
                    var r = $.trim($('#j-input').val())
                        , s = $('#j-input').data('filter')
                        , u = 'url' === s ? '_' : $('input[name="music_type"]:checked').val()
                        , x = $('<div class="aplayer-more">\u8F7D\u5165\u66F4\u591A</div>')
                        , y = !1
                        , z = function (A, B, C, D) {
                            var E = {
                                input: A,
                                filter: B,
                                type: C,
                                page: D
                            };
                            $.ajax({
                                type: 'POST',
                                url: c(),
                                timeout: 3e4,
                                data: E,
                                dataType: 'json',
                                beforeSend: function beforeSend() {
                                    y = !0;
                                    var F = document.title;
                                    'name' === B ? b(F, c('?name=' + A + '&type=' + C)) : 'id' === B ? b(F, c('?id=' + A + '&type=' + C)) : 'url' === B ? b(F, c('?url=' + encodeURIComponent(A))) : void 0,
                                        1 === D ? ($('#j-input').attr('disabled', !0),
                                            $('#j-submit').button('loading')) : x.text('\u8BF7\u7A0D\u540E...'),
                                        o(['_trackEvent', 'Ajax', 'beforeSend', d(E)])
                                },
                                success: function success(F) {
                                    if (o(['_trackEvent', 'Success', d(E), d(F.code)]),
                                        200 === F.code && F.data) {
                                        F.data.map(function (H) {
                                            H.title || (H.title = '\u6682\u65E0'),
                                                H.author || (H.author = '\u6682\u65E0'),
                                                H.pic || (H.pic = i),
                                                H.lrc || (H.lrc = '[00:00.00] \u6682\u65E0\u6B4C\u8BCD'),
                                                /\[00:(\d{2})\./.test(H.lrc) || (H.lrc = '[00:00.00] \u65E0\u6548\u6B4C\u8BCD')
                                        });
                                        var G = function (H) {
                                            if ($('#j-link').val(H.link),
                                                $('#j-link-btn').attr('href', H.link),
                                                $('#j-src').val(H.url),
                                                $('#j-src-btn').attr('href', H.url),
                                                $('#j-lrc').val(H.lrc),
                                                $('#j-lrc-btn').attr('href', 'data:application/octet-stream;base64,' + btoa(unescape(encodeURIComponent(H.lrc)))),
                                                'download' in $('#j-src-btn')[0]) {
                                                var I = H.title + '-' + H.author;
                                                $('#j-src-btn').attr('download', I + '.mp3'),
                                                    $('#j-lrc-btn').attr('download', I + '.lrc'),
                                                    $('#j-src-btn-icon, #j-lrc-btn-icon').addClass('am-icon-download').removeClass('am-icon-external-link')
                                            }
                                            $('#j-songid').val(H.songid),
                                                $('#j-name').val(H.title),
                                                $('#j-author').val(H.author)
                                        };
                                        1 === D ? (g && g.pause(),
                                            h = F.data,
                                            G(h[0]),
                                            $('#j-validator').slideUp(),
                                            $('#j-main').slideDown(),
                                            g = new APlayer({
                                                element: $('#j-player')[0],
                                                autoplay: !1,
                                                narrow: !1,
                                                showlrc: 1,
                                                mutex: !1,
                                                mode: 'circulation',
                                                preload: 'metadata',
                                                theme: '#0e90d2',
                                                music: F.data
                                            }),
                                            $('#j-player').append(x),
                                            x.on('click', function () {
                                                y || (D++ ,
                                                    z(A, B, C, D))
                                            })) : (g.addMusic(F.data),
                                                h = h.concat(F.data)),
                                            g.on('canplay', function () {
                                                g.play()
                                            }),
                                            g.on('play', function () {
                                                var H = h[g.playIndex]
                                                    , I = new Image;
                                                I.src = H.pic,
                                                    I.onerror = function () {
                                                        $('.aplayer-pic').css('background-image', 'url(' + i + ')')
                                                    }
                                                    ,
                                                    document.title = '\u6B63\u5728\u64AD\u653E: ' + H.title + ' - ' + H.author,
                                                    G(H),
                                                    o(['_trackEvent', 'Play', g.playIndex, d(H.link)])
                                            }),
                                            g.on('pause', function () {
                                                var H = F.data[g.playIndex];
                                                o(['_trackEvent', 'Pause', g.playIndex, H.title])
                                            }),
                                            g.on('ended', function () {
                                                var H = F.data[g.playIndex];
                                                document.title = j,
                                                    o(['_trackEvent', 'Ended', g.playIndex, H.title])
                                            }),
                                            10 > F.data.length ? x.hide() : x.text('\u8F7D\u5165\u66F4\u591A')
                                    } else
                                        1 === D ? $('#j-input').closest('.am-form-group').find('.am-alert').html(F.error || '(\xB0\u30FC\xB0\u3003) \u670D\u52A1\u5668\u597D\u50CF\u7F62\u5DE5\u4E86').show() : (x.text('\u6CA1\u6709\u4E86'),
                                            setTimeout(function () {
                                                x.slideUp()
                                            }, 1e3))
                                },
                                error: function error(F, G) {
                                    if (1 === D) {
                                        var H = '(\xB0\u30FC\xB0\u3003) \u51FA\u4E86\u70B9\u5C0F\u95EE\u9898\uFF0C\u8BF7\u91CD\u8BD5';
                                        'timeout' === G && (H = '(\xB0\u30FC\xB0\u3003) \u8BF7\u6C42\u8D85\u65F6\u4E86\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5'),
                                            $('#j-input').closest('.am-form-group').find('.am-alert').html(H).show(),
                                            o(['_trackEvent', 'Error', d(E), G])
                                    } else
                                        x.text('(\xB0\u30FC\xB0\u3003) \u52A0\u8F7D\u5931\u8D25\u4E86\uFF0C\u70B9\u51FB\u91CD\u8BD5')
                                },
                                complete: function complete() {
                                    y = !1,
                                        1 === D && ($('#j-input').attr('disabled', !1),
                                            $('#j-submit').button('reset'))
                                }
                            })
                        };
                    z(r, s, u, 1)
                }
            }
        }),
        $('#j-main input').focus(function () {
            $(this).select()
        }),
        $('#j-more').on('click', function () {
            $(this).hide(),
                $('#j-quote').removeClass('music-overflow'),
                o(['_trackEvent', 'click', 'more'])
        }),
        $('#j-back').on('click', function () {
            g && g.pause(),
                $('#j-validator').slideDown(),
                $('#j-main').slideUp(),
                $('#j-main input').val(''),
                document.title = j,
                o(['_trackEvent', 'click', 'back'])
        }),
        $.getScript('//w.cnzz.com/c.php?id=1255392159'),
        $.getScript('//od9jg7suh.qnssl.com/2333/js/console.js')
});
